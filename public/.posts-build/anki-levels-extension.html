<p>In this post, I’ll walk you through my implementation of Anki Levels,
a browser extension that bridges spaced repetition learning with
real-world reading. This project taught me that effective browser
extensions require careful attention to performance. The naive approach
of searching thousands of words through every text node on a page
creates noticeable lag. I learned to use IndexedDB for persistent
caching, batch processing with idle callbacks to avoid blocking the UI,
and the TreeWalker API for efficient DOM traversal. The most interesting
challenge was handling overlapping words in languages like Japanese
where longer phrases contain shorter words. The solution uses a
level-based layout system that stacks color-coded underlines, showing
multiple matches simultaneously without visual clutter. Working with the
WXT framework made cross-browser development straightforward, handling
manifest generation and build configuration automatically.</p>
<p>The core idea emerged from a frustration with traditional language
learning. When studying Japanese through Anki, I could review flashcards
effectively, but I had no sense of my progress in real-world contexts.
Which words on a news article would I recognize? Which kanji compounds
had I mastered? The disconnect between controlled flashcard review and
wild reading was jarring. I wanted a tool that would show me, in real
time, which words I knew well and which needed more practice. The result
is an extension that transforms any web page into a personalized
difficulty map, color-coding words from red (difficult) to green
(mastered) based on my actual Anki statistics.</p>
<div style="text-align: center; margin: 30px 0;">
<img src="/.posts-build/anki-levels-extension/Screenshot%202025-11-28%20at%2001.15.52.png" alt="Example of highlighted text" style="border: 1px solid #e5e7eb; border-radius: 8px;" />
<p style="margin-top: 10px; font-size: 0.9em; color: #666;">
Words highlighted with color-coded difficulty levels showing vocabulary
mastery across a web page.
</p>
</div>
<h1 id="architecture-and-data-flow">Architecture and Data Flow</h1>
<p>The extension follows a two-component architecture typical of modern
browser extensions: a background script that manages data
synchronization and a content script that highlights words on pages. The
separation of concerns is crucial for performance and reliability.</p>
<p>The background script (<code>background.ts</code>) runs persistently
and handles all communication with Anki through the AnkiConnect add-on.
AnkiConnect exposes a local HTTP API on <code>localhost:8765</code> that
allows external applications to query card data. The background script
fetches all cards from the “Japanese” deck (the default deck name),
computes difficulty levels based on card statistics, and caches the
results in IndexedDB. This architecture means content scripts never
directly communicate with Anki, they simply request pre-processed word
data from the background script.</p>
<p>The data flow works like this:</p>
<ol type="1">
<li>Background script connects to AnkiConnect and queries for all cards
in the “Japanese” deck</li>
<li>For each card, extract the “Expression” field (the word or phrase)
and statistics (interval, lapses, repetitions)</li>
<li>Compute a difficulty level from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>100</mn><annotation encoding="application/x-tex">100</annotation></semantics></math>
based on these statistics</li>
<li>Store the word-to-difficulty mapping in IndexedDB for instant
retrieval</li>
<li>Content scripts request this mapping when a page loads</li>
<li>Highlight words on the page using the difficulty data</li>
</ol>
<p>The separation between data fetching (background) and presentation
(content) is important for two reasons. First, it avoids making network
requests from content scripts, which run on every page and could be
blocked by content security policies. Second, it enables caching: once
the background script fetches data, all tabs can use it instantly
without redundant API calls.</p>
<h1 id="computing-difficulty-from-card-statistics">Computing Difficulty
from Card Statistics</h1>
<p>The most interesting algorithmic challenge was converting Anki’s card
statistics into a meaningful difficulty score. Anki tracks several
metrics for each card:</p>
<ul>
<li><strong>Interval</strong>: Days until the card is next due for
review</li>
<li><strong>Lapses</strong>: Number of times you’ve forgotten the
card</li>
<li><strong>Repetitions</strong>: Total number of reviews</li>
<li><strong>Ease</strong>: Ease factor (how easily you remember the
card)</li>
</ul>
<p>The interval is the most important signal. In spaced repetition,
longer intervals indicate stronger memory. A card with a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>180</mn><annotation encoding="application/x-tex">180</annotation></semantics></math>-day
interval is firmly in long-term memory, while a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>-day
interval means you just learned it. I designed a scoring function that
maps intervals to a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>100</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 100]</annotation></semantics></math>
scale:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">intervalScore</mtext><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mn>90</mn><mo>+</mo><mrow><mi mathvariant="normal">min</mi><mo>&#8289;</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>i</mi><mo>−</mo><mn>180</mn></mrow><mn>365</mn></mfrac><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mn>10</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mi>i</mi><mo>≥</mo><mn>180</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>75</mn><mo>+</mo><mfrac><mrow><mi>i</mi><mo>−</mo><mn>90</mn></mrow><mn>90</mn></mfrac><mo>⋅</mo><mn>15</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mn>90</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mn>180</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>50</mn><mo>+</mo><mfrac><mrow><mi>i</mi><mo>−</mo><mn>21</mn></mrow><mn>69</mn></mfrac><mo>⋅</mo><mn>25</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mn>21</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mn>90</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>30</mn><mo>+</mo><mfrac><mrow><mi>i</mi><mo>−</mo><mn>7</mn></mrow><mn>14</mn></mfrac><mo>⋅</mo><mn>20</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mn>7</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mn>21</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>10</mn><mo>+</mo><mfrac><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow><mn>6</mn></mfrac><mo>⋅</mo><mn>20</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mn>7</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mi>i</mi><mo>&lt;</mo><mn>1</mn></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{intervalScore}(i) = \begin{cases}
90 + \min\left(\frac{i - 180}{365}, 1\right) \cdot 10 &amp; \text{if } i \geq 180 \\
75 + \frac{i - 90}{90} \cdot 15 &amp; \text{if } 90 \leq i &lt; 180 \\
50 + \frac{i - 21}{69} \cdot 25 &amp; \text{if } 21 \leq i &lt; 90 \\
30 + \frac{i - 7}{14} \cdot 20 &amp; \text{if } 7 \leq i &lt; 21 \\
10 + \frac{i - 1}{6} \cdot 20 &amp; \text{if } 1 \leq i &lt; 7 \\
0 &amp; \text{if } i &lt; 1
\end{cases}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is the interval in days.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> intervalScore <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (interval <span class="op">&gt;=</span> <span class="dv">180</span>) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">90</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>((interval <span class="op">-</span> <span class="dv">180</span>) <span class="op">/</span> <span class="dv">365</span><span class="op">,</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">10</span><span class="op">;</span> <span class="co">// 90-100 for 6+ months</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (interval <span class="op">&gt;=</span> <span class="dv">90</span>) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">75</span> <span class="op">+</span> ((interval <span class="op">-</span> <span class="dv">90</span>) <span class="op">/</span> <span class="dv">90</span>) <span class="op">*</span> <span class="dv">15</span><span class="op">;</span> <span class="co">// 75-90 for 3-6 months</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (interval <span class="op">&gt;=</span> <span class="dv">21</span>) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">50</span> <span class="op">+</span> ((interval <span class="op">-</span> <span class="dv">21</span>) <span class="op">/</span> <span class="dv">69</span>) <span class="op">*</span> <span class="dv">25</span><span class="op">;</span> <span class="co">// 50-75 for 3 weeks to 3 months</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (interval <span class="op">&gt;=</span> <span class="dv">7</span>) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">30</span> <span class="op">+</span> ((interval <span class="op">-</span> <span class="dv">7</span>) <span class="op">/</span> <span class="dv">14</span>) <span class="op">*</span> <span class="dv">20</span><span class="op">;</span> <span class="co">// 30-50 for 1-3 weeks</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (interval <span class="op">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">10</span> <span class="op">+</span> ((interval <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">6</span>) <span class="op">*</span> <span class="dv">20</span><span class="op">;</span> <span class="co">// 10-30 for 1-7 days</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  intervalScore <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// New card</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This function is piecewise linear, with steeper slopes for shorter
intervals where changes matter more. Going from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
day to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math>
days is a big jump
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>10</mn><annotation encoding="application/x-tex">10</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>30</mn><annotation encoding="application/x-tex">30</annotation></semantics></math>
points), while going from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>180</mn><annotation encoding="application/x-tex">180</annotation></semantics></math>
days to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>365</mn><annotation encoding="application/x-tex">365</annotation></semantics></math>
days is incremental
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>90</mn><annotation encoding="application/x-tex">90</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>95</mn><annotation encoding="application/x-tex">95</annotation></semantics></math>
points). The breakpoints reflect natural milestones in spaced
repetition: one week (established in short-term memory), three weeks
(transitioning to medium-term), three months (solid medium-term), six
months (entering long-term).</p>
<p>Lapses apply a penalty because mistakes indicate difficulty:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">lapsesScore</mtext><mo stretchy="false" form="prefix">(</mo><mi>l</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>−</mi><mrow><mi mathvariant="normal">min</mi><mo>&#8289;</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>l</mi><mo>⋅</mo><mn>5</mn><mo>,</mo><mn>25</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\text{lapsesScore}(l) = -\min(l \cdot 5, 25)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
is the number of lapses.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> lapsesScore <span class="op">=</span> <span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(lapses <span class="op">*</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">25</span>)<span class="op">;</span></span></code></pre></div>
<p>Each lapse costs
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
points, capped at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>25</mn><annotation encoding="application/x-tex">25</annotation></semantics></math>
points total. This is intentionally gentle because occasional lapses are
normal, especially for difficult words. I don’t want a single mistake to
tank a word’s score.</p>
<p>Repetitions provide a small bonus:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">repsBonus</mtext><mo stretchy="false" form="prefix">(</mo><mi>r</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mrow><mi mathvariant="normal">min</mi><mo>&#8289;</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>r</mi><mo>⋅</mo><mn>2</mn><mo>,</mo><mn>10</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mi>r</mi><mo>&gt;</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
\text{repsBonus}(r) = \begin{cases}
\min(r \cdot 2, 10) &amp; \text{if } r &gt; 0 \\
0 &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
is the number of repetitions.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> repsBonus <span class="op">=</span> reps <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(reps <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">10</span>) <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
<p>Even if the interval is short, having reviewed a card multiple times
shows engagement. This helps distinguish truly new cards (never
reviewed) from young cards (recently started).</p>
<p>The final score combines these:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">difficultyLevel</mtext><mo>=</mo><mrow><mi mathvariant="normal">max</mi><mo>&#8289;</mo></mrow><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo>,</mo><mrow><mi mathvariant="normal">min</mi><mo>&#8289;</mo></mrow><mo stretchy="false" form="prefix">(</mo><mn>100</mn><mo>,</mo><mtext mathvariant="normal">intervalScore</mtext><mo>+</mo><mtext mathvariant="normal">lapsesScore</mtext><mo>+</mo><mtext mathvariant="normal">repsBonus</mtext><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\text{difficultyLevel} = \max(0, \min(100, \text{intervalScore} + \text{lapsesScore} + \text{repsBonus}))
</annotation></semantics></math></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> difficultyLevel <span class="op">=</span> intervalScore <span class="op">+</span> lapsesScore <span class="op">+</span> repsBonus<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>difficultyLevel <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">100</span><span class="op">,</span> difficultyLevel))<span class="op">;</span></span></code></pre></div>
<p>Clamping to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>100</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 100]</annotation></semantics></math>
ensures the output is always a valid percentage. The result is a single
number that captures how well I know each word, derived from my actual
learning history.</p>
<h1 id="performance-optimization-with-indexeddb">Performance
Optimization with IndexedDB</h1>
<p>The extension needs to handle thousands of words efficiently. My
Japanese deck contains over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">5{,}000</annotation></semantics></math>
cards. Fetching this data from Anki on every page load would be slow and
wasteful. The solution is aggressive caching using IndexedDB.</p>
<p>IndexedDB is a browser-native database that persists data locally.
Unlike <code>localStorage</code> (limited to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>10</mn><annotation encoding="application/x-tex">10</annotation></semantics></math>
MB), IndexedDB can store large datasets. I created a simple wrapper
class around IndexedDB to store the word-to-difficulty mapping:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnkiDB {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> dbName <span class="op">=</span> <span class="st">&quot;AnkiLevelsDB&quot;</span><span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> storeName <span class="op">=</span> <span class="st">&quot;words&quot;</span><span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">saveWords</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    words<span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> { difficultyLevel<span class="op">:</span> <span class="dt">number</span> }<span class="op">&gt;,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  )<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transaction <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">!.</span><span class="fu">transaction</span>([<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span>]<span class="op">,</span> <span class="st">&quot;readwrite&quot;</span>)<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> transaction<span class="op">.</span><span class="fu">objectStore</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span>)<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear existing data</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    store<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add all words</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    words<span class="op">.</span><span class="fu">forEach</span>((data<span class="op">,</span> word) <span class="kw">=&gt;</span> {</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      store<span class="op">.</span><span class="fu">put</span>({ word<span class="op">,</span> difficultyLevel<span class="op">:</span> data<span class="op">.</span><span class="at">difficultyLevel</span> })<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getWords</span>()<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> { difficultyLevel<span class="op">:</span> <span class="dt">number</span> }<span class="op">&gt;</span> <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span> {</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transaction <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">!.</span><span class="fu">transaction</span>([<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span>]<span class="op">,</span> <span class="st">&quot;readonly&quot;</span>)<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> transaction<span class="op">.</span><span class="fu">objectStore</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span>)<span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert array to Map for fast lookups</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> wordMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> { difficultyLevel<span class="op">:</span> <span class="dt">number</span> }<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    results<span class="op">.</span><span class="fu">forEach</span>((item<span class="op">:</span> <span class="dt">any</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      wordMap<span class="op">.</span><span class="fu">set</span>(item<span class="op">.</span><span class="at">word</span><span class="op">,</span> { difficultyLevel<span class="op">:</span> item<span class="op">.</span><span class="at">difficultyLevel</span> })<span class="op">;</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wordMap<span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The key operations are <code>saveWords</code> (called after syncing
with Anki) and <code>getWords</code> (called by content scripts). Using
a <code>Map</code> for the in-memory representation gives
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math>
lookup time when checking if a word exists.</p>
<p>The background script syncs with Anki on a schedule:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> SYNC_INTERVAL <span class="op">=</span> <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 24 hours</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">syncWithAnki</span>() {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Syncing with Anki...&quot;</span>)<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> words <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetchJapaneseCards</span>()<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  cachedWords <span class="op">=</span> words<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> db<span class="op">.</span><span class="fu">saveWords</span>(words)<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> db<span class="op">.</span><span class="fu">saveMetadata</span>(<span class="st">&quot;lastSync&quot;</span><span class="op">,</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>())<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Synced </span><span class="sc">${</span>words<span class="op">.</span><span class="at">size</span><span class="sc">}</span><span class="vs"> words from Anki`</span>)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">// On startup, load from IndexedDB immediately</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> savedWords <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getWords</span>()<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (savedWords) {</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  cachedWords <span class="op">=</span> savedWords<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Loaded </span><span class="sc">${</span>savedWords<span class="op">.</span><span class="at">size</span><span class="sc">}</span><span class="vs"> words from IndexedDB`</span>)<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Check if we need to sync</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> lastSync <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getMetadata</span>(<span class="st">&quot;lastSync&quot;</span>)<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>lastSync <span class="op">||</span> now <span class="op">-</span> lastSync <span class="op">&gt;</span> SYNC_INTERVAL) {</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">syncWithAnki</span>()<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This gives the best of both worlds: instant loading from IndexedDB
cache on every page, and periodic background syncing to keep data fresh.
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>24</mn><annotation encoding="application/x-tex">24</annotation></semantics></math>-hour
interval balances freshness with performance. Most people don’t review
enough cards in a day to significantly change the difficulty
distribution.</p>
<p>Fetching data from Anki itself is optimized with batching:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> BATCH_SIZE <span class="op">=</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> batches<span class="op">:</span> <span class="dt">number</span>[][] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> cardIds<span class="op">.</span><span class="at">length</span><span class="op">;</span> i <span class="op">+=</span> BATCH_SIZE) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  batches<span class="op">.</span><span class="fu">push</span>(cardIds<span class="op">.</span><span class="fu">slice</span>(i<span class="op">,</span> i <span class="op">+</span> BATCH_SIZE))<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Process batches in parallel (max 5 concurrent requests)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> MAX_CONCURRENT <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> batches<span class="op">.</span><span class="at">length</span><span class="op">;</span> i <span class="op">+=</span> MAX_CONCURRENT) {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> batchGroup <span class="op">=</span> batches<span class="op">.</span><span class="fu">slice</span>(i<span class="op">,</span> i <span class="op">+</span> MAX_CONCURRENT)<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    batchGroup<span class="op">.</span><span class="fu">map</span>((batch) <span class="kw">=&gt;</span> <span class="fu">callAnkiConnect</span>(<span class="st">&quot;cardsInfo&quot;</span><span class="op">,</span> { cards<span class="op">:</span> batch }))<span class="op">,</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  results<span class="op">.</span><span class="fu">forEach</span>((result) <span class="kw">=&gt;</span> allCardsInfo<span class="op">.</span><span class="fu">push</span>(<span class="op">...</span>result))<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Instead of fetching card info one at a time
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">5{,}000</annotation></semantics></math>
sequential API calls), we batch
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>500</mn><annotation encoding="application/x-tex">500</annotation></semantics></math>
cards per request and process
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
requests concurrently. This reduces the sync from minutes to
seconds.</p>
<h1 id="efficient-dom-traversal-and-highlighting">Efficient DOM
Traversal and Highlighting</h1>
<p>The content script faces the hardest performance challenge: finding
and highlighting words in the page’s DOM without blocking the UI. Web
pages can have tens of thousands of text nodes. Naively searching every
node for every word would be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><mtext mathvariant="normal">nodes</mtext><mo>×</mo><mtext mathvariant="normal">words</mtext><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(\text{nodes} \times \text{words})</annotation></semantics></math>,
which is prohibitively slow.</p>
<p>The solution uses several optimizations:</p>
<p><strong>TreeWalker API</strong>: Instead of recursively walking the
DOM tree manually, I use the built-in <code>TreeWalker</code> API to
efficiently find all text nodes:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> walker <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createTreeWalker</span>(<span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">,</span> <span class="bu">NodeFilter</span><span class="op">.</span><span class="at">SHOW_TEXT</span><span class="op">,</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  acceptNode<span class="op">:</span> (node) <span class="kw">=&gt;</span> {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parent <span class="op">=</span> node<span class="op">.</span><span class="at">parentElement</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tagName <span class="op">=</span> parent<span class="op">.</span><span class="at">tagName</span><span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip script, style, textarea, input</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      tagName <span class="op">===</span> <span class="st">&quot;SCRIPT&quot;</span> <span class="op">||</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      tagName <span class="op">===</span> <span class="st">&quot;STYLE&quot;</span> <span class="op">||</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      tagName <span class="op">===</span> <span class="st">&quot;TEXTAREA&quot;</span> <span class="op">||</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      tagName <span class="op">===</span> <span class="st">&quot;INPUT&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    ) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">NodeFilter</span><span class="op">.</span><span class="at">FILTER_REJECT</span><span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">NodeFilter</span><span class="op">.</span><span class="at">FILTER_ACCEPT</span><span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> textNodes<span class="op">:</span> <span class="bu">Text</span>[] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> node<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> ((node <span class="op">=</span> walker<span class="op">.</span><span class="fu">nextNode</span>())) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  textNodes<span class="op">.</span><span class="fu">push</span>(node <span class="im">as</span> <span class="bu">Text</span>)<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The filter rejects nodes we should never highlight (scripts, styles,
form inputs). This reduces the search space significantly.</p>
<p><strong>Batch processing with idle callbacks</strong>: Processing all
nodes at once would freeze the page. Instead, I process nodes in batches
during idle time:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> batchSize <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> processed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">processBatch</span>() {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> end <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(processed <span class="op">+</span> batchSize<span class="op">,</span> textNodes<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> deadline <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="dv">8</span><span class="op">;</span> <span class="co">// Max 8ms per batch</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> processed<span class="op">;</span> i <span class="op">&lt;</span> end<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">&gt;=</span> deadline) <span class="cf">break</span><span class="op">;</span> <span class="co">// Don&#39;t block too long</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> textNode <span class="op">=</span> textNodes[i]<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... highlight words in this node ...</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  processed <span class="op">=</span> end<span class="op">;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (processed <span class="op">&lt;</span> textNodes<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestIdleCallback</span>(processBatch<span class="op">,</span> { timeout<span class="op">:</span> <span class="dv">1000</span> })<span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="fu">processBatch</span>()<span class="op">;</span></span></code></pre></div>
<p>Each batch processes up to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>50</mn><annotation encoding="application/x-tex">50</annotation></semantics></math>
nodes but yields control if it takes more than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math>
ms. This keeps the page responsive. Using
<code>requestIdleCallback</code> tells the browser to schedule
processing when the main thread is idle, so it doesn’t interfere with
scrolling or interaction.</p>
<p><strong>Quick substring checks</strong>: Before doing expensive
matching, we check if a word could possibly exist in the text:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">const</span> [word<span class="op">,</span> data] <span class="kw">of</span> sortedWords) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>text<span class="op">.</span><span class="fu">includes</span>(word)) <span class="cf">continue</span><span class="op">;</span> <span class="co">// Fast rejection</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... do expensive matching ...</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>includes</code> check is a fast native string search. For
text that doesn’t contain any target words, this skips all the matching
logic.</p>
<p><strong>Sorted words for longest-match-first</strong>: Words are
sorted by length (longest first) before matching. This ensures that if
both “日本” (Japan) and “日本語” (Japanese language) are in the deck, we
match the longer “日本語” first. Otherwise, “日本” would match and
consume those characters, preventing the longer match.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sortedWords <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(wordsMap<span class="op">.</span><span class="fu">entries</span>())<span class="op">.</span><span class="fu">sort</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  (a<span class="op">,</span> b) <span class="kw">=&gt;</span> b[<span class="dv">0</span>]<span class="op">.</span><span class="at">length</span> <span class="op">-</span> a[<span class="dv">0</span>]<span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<h1 id="handling-overlapping-words">Handling Overlapping Words</h1>
<p>In Japanese (and many languages), words can overlap. Consider the
sentence “日本語を勉強する” (I study Japanese). If my deck contains both
“日本語” (Japanese language), “日本” (Japan), “勉強” (study), and
“勉強する” (to study), we have overlapping matches:</p>
<ul>
<li>“日本語” matches characters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></li>
<li>“日本” matches characters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
(overlaps with “日本語”)</li>
<li>“勉強する” matches characters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math></li>
<li>“勉強” matches characters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
(overlaps with “勉強する”)</li>
</ul>
<p>Simply highlighting the longest match would lose information about
the shorter words. The user should see that they know both “日本” and
the compound “日本語”, possibly at different difficulty levels.</p>
<p>My solution is to highlight based on the primary (longest) match but
add color-coded underlines for all overlapping words. Each underline is
stacked vertically to avoid overlap:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Group overlapping matches</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">const</span> match <span class="kw">of</span> matches) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> existingGroup <span class="op">=</span> finalMatches<span class="op">.</span><span class="fu">find</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    (existing) <span class="kw">=&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      (match<span class="op">.</span><span class="at">index</span> <span class="op">&gt;=</span> existing<span class="op">.</span><span class="at">index</span> <span class="op">&amp;&amp;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        match<span class="op">.</span><span class="at">index</span> <span class="op">&lt;</span> existing<span class="op">.</span><span class="at">index</span> <span class="op">+</span> existing<span class="op">.</span><span class="at">length</span>) <span class="op">||</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      (match<span class="op">.</span><span class="at">index</span> <span class="op">+</span> match<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> existing<span class="op">.</span><span class="at">index</span> <span class="op">&amp;&amp;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        match<span class="op">.</span><span class="at">index</span> <span class="op">&lt;</span> existing<span class="op">.</span><span class="at">index</span>)<span class="op">,</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (existingGroup) {</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    existingGroup<span class="op">.</span><span class="at">overlapping</span><span class="op">.</span><span class="fu">push</span>(match)<span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    finalMatches<span class="op">.</span><span class="fu">push</span>({ <span class="op">...</span>match<span class="op">,</span> overlapping<span class="op">:</span> [match] })<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This groups matches that overlap into clusters. For each cluster, we
highlight the background using the primary match’s color and add stacked
underlines for all matches:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Assign vertical levels to avoid underline overlap</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> levels<span class="op">:</span> <span class="dt">number</span>[] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>match<span class="op">.</span><span class="at">overlapping</span><span class="op">.</span><span class="fu">forEach</span>((m<span class="op">,</span> idx) <span class="kw">=&gt;</span> {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> level <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> hasOverlap <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> idx<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (levels[i] <span class="op">===</span> level) {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if they overlap at this level</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> mEnd <span class="op">=</span> m<span class="op">.</span><span class="at">index</span> <span class="op">+</span> m<span class="op">.</span><span class="at">word</span><span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> otherEnd <span class="op">=</span> other<span class="op">.</span><span class="at">index</span> <span class="op">+</span> other<span class="op">.</span><span class="at">word</span><span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>(mEnd <span class="op">&lt;=</span> other<span class="op">.</span><span class="at">index</span> <span class="op">||</span> m<span class="op">.</span><span class="at">index</span> <span class="op">&gt;=</span> otherEnd)) {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>          hasOverlap <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>hasOverlap) {</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>      levels[idx] <span class="op">=</span> level<span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    level<span class="op">++;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>This algorithm assigns each overlapping word to a vertical level such
that words at the same level don’t overlap. It’s a simple greedy
allocation: for each word, try level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.
If there’s already a word at level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
that overlaps, try level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>,
and so on.</p>
<p>The underlines are positioned using CSS:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>match<span class="op">.</span><span class="at">overlapping</span><span class="op">.</span><span class="fu">forEach</span>((m<span class="op">,</span> idx) <span class="kw">=&gt;</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> <span class="fu">getDifficultyColor</span>(m<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">difficultyLevel</span>)<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> level <span class="op">=</span> levels[idx]<span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> offset <span class="op">=</span> <span class="vs">`calc(-1 * (1px + </span><span class="sc">${</span>level <span class="op">*</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">px))`</span><span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> relativeStart <span class="op">=</span> m<span class="op">.</span><span class="at">index</span> <span class="op">-</span> match<span class="op">.</span><span class="at">index</span><span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> matchLength <span class="op">=</span> m<span class="op">.</span><span class="at">word</span><span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalLength <span class="op">=</span> match<span class="op">.</span><span class="at">word</span><span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> leftPercent <span class="op">=</span> (relativeStart <span class="op">/</span> totalLength) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> widthPercent <span class="op">=</span> (matchLength <span class="op">/</span> totalLength) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> underline <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;span&quot;</span>)<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  underline<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">left</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>leftPercent<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  underline<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`calc(</span><span class="sc">${</span>widthPercent<span class="sc">}</span><span class="vs">% - 2%)`</span><span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  underline<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">bottom</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>offset<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  underline<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="st">&quot;1.5px&quot;</span><span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  underline<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">backgroundColor</span> <span class="op">=</span> color<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  span<span class="op">.</span><span class="fu">appendChild</span>(underline)<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Each underline is an absolutely-positioned child span, placed at a
percentage offset within the parent highlight span. This ensures the
underline length matches the word length, even when multiple words
overlap.</p>
<div style="text-align: center; margin: 30px 0;">
<img src="/.posts-build/anki-levels-extension/Screenshot%202025-11-28%20at%2001.17.19.png" alt="Overlapping word detection" style="border: 1px solid #e5e7eb; border-radius: 8px;" />
<p style="margin-top: 10px; font-size: 0.9em; color: #666;">
Multiple overlapping words shown with stacked color-coded underlines.
</p>
</div>
<p>The result is visually clean. Users can hover over a highlighted word
to see a tooltip listing all matches and their difficulty
percentages:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (match<span class="op">.</span><span class="at">overlapping</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tooltipLines <span class="op">=</span> match<span class="op">.</span><span class="at">overlapping</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>((m) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">.</span><span class="at">word</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(m<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">difficultyLevel</span>)<span class="sc">}</span><span class="vs">%)`</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  span<span class="op">.</span><span class="at">title</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>tooltipLines<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  span<span class="op">.</span><span class="at">title</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>match<span class="op">.</span><span class="at">word</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(match<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">difficultyLevel</span>)<span class="sc">}</span><span class="vs">%)`</span><span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h1 id="color-coding-and-visual-design">Color Coding and Visual
Design</h1>
<p>The color scheme maps difficulty levels to a red-to-green gradient.
Red indicates difficult words (low score), green indicates mastered
words (high score):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">color</mtext><mo stretchy="false" form="prefix">(</mo><mi>d</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mtext mathvariant="normal">rgb</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mo stretchy="true" form="prefix">⌊</mo><mn>255</mn><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mfrac><mi>d</mi><mn>100</mn></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">⌋</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">⌊</mo><mn>255</mn><mo>⋅</mo><mfrac><mi>d</mi><mn>100</mn></mfrac><mo stretchy="true" form="postfix">⌋</mo></mrow><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\text{color}(d) = \text{rgb}\left(\left\lfloor 255 \cdot \left(1 - \frac{d}{100}\right) \right\rfloor, \left\lfloor 255 \cdot \frac{d}{100} \right\rfloor, 0\right)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>d</mi><annotation encoding="application/x-tex">d</annotation></semantics></math>
is the difficulty level in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>100</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 100]</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getDifficultyColor</span>(level<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> <span class="dt">string</span> {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> red <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(<span class="dv">255</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> level <span class="op">/</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> green <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(<span class="dv">255</span> <span class="op">*</span> (level <span class="op">/</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="vs">`rgb(</span><span class="sc">${</span>red<span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>green<span class="sc">}</span><span class="vs">, 0)`</span><span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This produces a smooth gradient:</p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">0\%</annotation></semantics></math>
→ <code>rgb(255, 0, 0)</code> (red)</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">25\%</annotation></semantics></math>
→ <code>rgb(191, 64, 0)</code> (orange)</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">50\%</annotation></semantics></math>
→ <code>rgb(127, 127, 0)</code> (yellow)</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>75</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">75\%</annotation></semantics></math>
→ <code>rgb(64, 191, 0)</code> (yellow-green)</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">100\%</annotation></semantics></math>
→ <code>rgb(0, 255, 0)</code> (green)</li>
</ul>
<p>The background is the color at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">20\%</annotation></semantics></math>
opacity (alpha =
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.2</mn><annotation encoding="application/x-tex">0.2</annotation></semantics></math>
in hex, or <code>33</code> in hex notation):</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>span<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">backgroundColor</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>primaryColor<span class="sc">}</span><span class="vs">33`</span><span class="op">;</span></span></code></pre></div>
<p>This provides subtle highlighting that doesn’t obscure the text. The
underlines are fully opaque, making them stand out for quick visual
scanning.</p>
<div style="text-align: center; margin: 30px 0;">
<img src="/.posts-build/anki-levels-extension/Screenshot%202025-11-28%20at%2001.17.40.png" alt="Color-coded difficulty levels" style="border: 1px solid #e5e7eb; border-radius: 8px;" />
<p style="margin-top: 10px; font-size: 0.9em; color: #666;">
Different difficulty levels shown with color gradient from red to green.
</p>
</div>
<h1 id="browser-extension-development-with-wxt">Browser Extension
Development with WXT</h1>
<p>I built the extension using the WXT framework, which streamlines
cross-browser extension development. WXT handles the boilerplate:
generating manifest files, setting up TypeScript, managing builds for
Chrome and Firefox, and providing a development server with hot
reload.</p>
<p>The configuration is minimal:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="fu">defineConfig</span>({</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  manifest<span class="op">:</span> {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> <span class="st">&quot;Anki Levels&quot;</span><span class="op">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    description<span class="op">:</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Highlight words on web pages based on your Anki card difficulty levels&quot;</span><span class="op">,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    permissions<span class="op">:</span> [<span class="st">&quot;storage&quot;</span><span class="op">,</span> <span class="st">&quot;tabs&quot;</span>]<span class="op">,</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>WXT automatically generates <code>manifest.json</code> for both
Manifest V3 (Chrome) and Manifest V2 (Firefox). The
<code>entrypoints</code> directory structure maps directly to extension
components:</p>
<ul>
<li><code>entrypoints/background.ts</code> → background service
worker</li>
<li><code>entrypoints/content.ts</code> → content script</li>
</ul>
<p>TypeScript compilation, bundling, and output directory management are
all handled automatically. Development mode (<code>npm run dev</code>)
watches for changes and rebuilds instantly. This made iteration fast, I
could modify the highlighting algorithm and see results immediately
without manual reloading.</p>
<p>The permissions are minimal. <code>storage</code> is needed for
IndexedDB caching. Notably, I don’t request broad permissions like
<code>&lt;all_urls&gt;</code> for the background script. Only the
content script runs on pages, and it communicates with the background
script through message passing.</p>
<h1 id="real-world-usage-and-lessons-learned">Real-World Usage and
Lessons Learned</h1>
<p>Using the extension has changed how I read Japanese content online.
News articles, blog posts, and documentation now display as personalized
difficulty maps. At a glance, I can see which articles are within my
current level and which will challenge me. Words I’ve mastered (green)
fade into the background, while words I’m struggling with (red-orange)
stand out, prompting review.</p>
<p>The most surprising insight was how much vocabulary I’ve acquired
without realizing it. Articles that felt intimidating are often
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>70</mn><annotation encoding="application/x-tex">70</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>80</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">80\%</annotation></semantics></math>
green. Conversely, some words I thought I knew well are still orange,
revealing gaps in my retention. This visual feedback loop makes reading
more engaging and provides natural motivation for reviewing difficult
words.</p>
<p>Performance in practice has been excellent. Pages with thousands of
Japanese characters (like Wikipedia articles) highlight in under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>200</mn><annotation encoding="application/x-tex">200</annotation></semantics></math>
ms. The idle callback batching prevents any noticeable lag during
scrolling or interaction. Syncing with Anki takes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
seconds for my
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">5{,}000</annotation></semantics></math>-card
deck, which is acceptable for a background task that runs once per
day.</p>
<p>One limitation I discovered is that the extension works best with
languages where words are clearly separated or where Anki cards
represent discrete vocabulary items. For languages with complex
morphology or agglutination, the exact-match approach can miss
conjugations or variations. A future enhancement could use stemming or
lemmatization to match word families.</p>
<p>The project also reinforced the importance of caching and lazy
loading in browser extensions. Background scripts are service workers in
Manifest V3, meaning they can be terminated at any time to save memory.
All state must be persisted in <code>chrome.storage</code> or IndexedDB.
Content scripts are isolated from each other, so each tab must request
data independently. Designing for these constraints from the start
prevents bugs and improves reliability.</p>
<hr />
<p>Building Anki Levels taught me that effective browser extensions
require balancing functionality, performance, and user experience. The
core algorithm is simple (fetch words, compute difficulty, highlight
matches), but the devil is in the details: efficient DOM traversal,
responsive UI during processing, handling edge cases like overlapping
words, and presenting information clearly without overwhelming the
page.</p>
<p>The extension bridges two worlds: the controlled environment of
flashcard review and the chaotic reality of native content. By
visualizing my Anki progress in context, it makes learning tangible.
Instead of abstract statistics (this card has a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>90</mn><annotation encoding="application/x-tex">90</annotation></semantics></math>-day
interval), I see immediate feedback (I can read this article because
these words are green). This closes the gap between studying and using
the language, which is ultimately the goal of language learning.</p>
<p>The code is straightforward, just a few hundred lines of TypeScript,
yet it has become an indispensable tool in my daily routine.
Understanding how it works, from the difficulty scoring algorithm to the
level-based underline layout, gives me confidence to extend it further.
Future possibilities include support for multiple decks, custom color
schemes, difficulty histograms for articles, and integration with other
spaced repetition systems. The foundation is solid, and the potential is
exciting.</p>

<p>In this post, I’ll walk you through my implementation of a networked
game engine server that exposes an Entity-Component-System (ECS)
architecture through a RESTful API. This project taught me that building
a game engine is fundamentally about managing state and orchestrating
concurrent operations. The technical challenge lies in coordinating
multiple subsystems (rendering, scripting, networking) that all operate
on shared state while maintaining thread safety. I learned that the
Entity-Component-System pattern elegantly separates data (components)
from behavior (systems), making the codebase modular and extensible. The
combination of Flask for network control and VisPy for GPU-accelerated
rendering proved ideal, letting me focus on the architecture rather than
low-level graphics programming. Most importantly, I discovered that
thread synchronization is critical when the rendering loop runs on the
main thread while HTTP requests arrive asynchronously on worker
threads.</p>
<p>Game engines traditionally bundle everything into a monolithic
application: the editor, renderer, physics engine, and asset pipeline
all in one executable. I wanted to explore a different architecture
where the engine core runs as a networked service that clients can
control remotely via HTTP. This enables interesting use cases: multiple
clients collaborating on the same scene, scripted automation of engine
operations, and integration with external tools that speak HTTP. The
Entity-Component-System pattern provides the foundation, allowing
flexible composition of game objects from reusable components.</p>
<p>The challenge was to build a complete system that handles entity
lifecycle management (creation, modification, deletion), component
attachment with validation and type safety, 3D mesh rendering with
real-time transforms, Python script execution within the engine context,
and thread-safe concurrent access from HTTP handlers and the render
loop. Each aspect required careful design to maintain correctness and
performance.</p>
<h1 id="entity-component-system-architecture">Entity-Component-System
Architecture</h1>
<p>The Entity-Component-System pattern separates traditional
object-oriented game objects into three concepts. Entities are simply
integer IDs that serve as handles to game objects. They have no data or
behavior themselves, just a unique identifier. Components are pure data
structures that represent specific attributes: Transform holds position
and scale, Renderer references a 3D mesh file, Script points to
executable Python code, and CoreProperties stores metadata like name and
tags.</p>
<p>I implement entities using the Esper library, a lightweight Python
ECS framework. Esper manages the mapping between entity IDs and their
associated components, providing efficient queries and storage:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> esper</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Transform:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    position: List[<span class="bu">float</span>]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    scale: List[<span class="bu">float</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Renderer:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    file_path: <span class="bu">str</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Script:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    script_path: <span class="bu">str</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CoreProperties:</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    tags: List[<span class="bu">str</span>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    target_scene: <span class="bu">str</span></span></code></pre></div>
<p>Creating an entity is straightforward. The client sends a POST
request with entity metadata, and the server creates an entity with a
CoreProperties component:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_entity(name, target_scene, tags):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    base_entity_component <span class="op">=</span> CoreProperties(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>name,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        tags<span class="op">=</span>tags,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        target_scene<span class="op">=</span>target_scene,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> esper.create_entity(base_entity_component)</span></code></pre></div>
<p>Esper returns an integer ID that the client uses for all subsequent
operations. This ID is persistent until the entity is explicitly
deleted. The separation between entity ID and component data means
entities are lightweight. Creating thousands of entities has minimal
overhead because we’re just allocating integers and registering them in
Esper’s internal bookkeeping.</p>
<p>Components are added dynamically after entity creation. The client
specifies the component type and provides the required data:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@flask_app.route</span>(<span class="st">&quot;/add_component_to_entity&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_component_to_entity_endpoint():</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> request.json</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    entity_id <span class="op">=</span> parameters.get(<span class="st">&quot;entityId&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    component_type <span class="op">=</span> parameters.get(<span class="st">&quot;type&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    component_data <span class="op">=</span> parameters.get(<span class="st">&quot;data&quot;</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    component_types_association <span class="op">=</span> {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;transform&quot;</span>: Transform,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;script&quot;</span>: Script,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;renderer&quot;</span>: Renderer,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    component_class <span class="op">=</span> component_types_association.get(component_type)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    component_data <span class="op">=</span> convert_keys_to_snake_case(component_data)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    component <span class="op">=</span> component_class(<span class="op">**</span>component_data)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    add_component_to_entity(entity_id, component)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_response()</span></code></pre></div>
<p>The conversion from camelCase to snake_case handles the impedance
mismatch between JavaScript naming conventions (used by clients) and
Python conventions. The server validates component data before
instantiation. For Transform components, I check that position and scale
are three-element arrays of numbers, scale values are positive, and
values are within reasonable bounds (less than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>6</mn></msup><annotation encoding="application/x-tex">10^6</annotation></semantics></math>
to prevent overflow).</p>
<h1 id="thread-safe-rendering-with-vispy">Thread-Safe Rendering with
VisPy</h1>
<p>The rendering subsystem uses VisPy, a Python library for interactive
scientific visualization built on OpenGL. VisPy provides scene graph
management, camera controls, and mesh rendering without requiring
low-level OpenGL calls. The key challenge is that VisPy’s event loop
must run on the main thread (OpenGL requirement), while Flask handles
HTTP requests on worker threads. All operations that modify the scene
graph must be synchronized.</p>
<p>I use a global lock to protect access to the Esper world state:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>world_lock <span class="op">=</span> threading.Lock()</span></code></pre></div>
<p>Every HTTP endpoint that reads or modifies entities acquires this
lock:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@flask_app.route</span>(<span class="st">&quot;/create_entity&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_entity_endpoint():</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> request.json</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    name_data <span class="op">=</span> parameters.get(<span class="st">&quot;name&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    target_scene_data <span class="op">=</span> parameters.get(<span class="st">&quot;targetScene&quot;</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    tags_data <span class="op">=</span> parameters.get(<span class="st">&quot;tags&quot;</span>, [])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> world_lock:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        entity_id <span class="op">=</span> create_entity(name_data, target_scene_data, tags_data)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success_response(data<span class="op">=</span>{<span class="st">&quot;entityId&quot;</span>: entity_id})</span></code></pre></div>
<p>The Renderer component handler demonstrates the complexity of
cross-thread coordination. When a client attaches a Renderer component,
the server must load the 3D mesh file, create a VisPy mesh visual, add
it to the scene graph, and register it for updates:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> handle_renderer_component(entity_id, renderer: Renderer):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> renderer.file_path</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> vispy <span class="im">import</span> io, scene</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> server.configuration <span class="im">import</span> view</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isfile(file_path):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> error_response(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">=</span><span class="st">&quot;File path must point to a valid file&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">400</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    vertices, faces, normals, _ <span class="op">=</span> io.read_mesh(file_path)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    mesh <span class="op">=</span> scene.visuals.Mesh(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        vertices,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        faces,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        normals,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        shading<span class="op">=</span><span class="st">&quot;flat&quot;</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        parent<span class="op">=</span>view.scene,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> vispy.visuals.transforms <span class="im">import</span> MatrixTransform</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    mesh.transform <span class="op">=</span> MatrixTransform()</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> meshes_lock:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        meshes.append({</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;entityId&quot;</span>: entity_id,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;filePath&quot;</span>: file_path,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;meshObject&quot;</span>: mesh,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;toBeTransformed&quot;</span>: <span class="va">True</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> world_lock:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        esper.add_component(entity_id, renderer)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success_response()</span></code></pre></div>
<p>The <code>meshes</code> list is a global registry that maps entity
IDs to their corresponding VisPy mesh objects. This enables the script
system to locate and manipulate meshes at runtime. The
<code>toBeTransformed</code> flag signals that the mesh needs its
transform matrix updated on the next frame.</p>
<p>VisPy loads mesh files using the <code>io.read_mesh</code> function,
which supports OBJ, FBX, DAE, GLTF, and GLB formats via the Assimp
library. The function returns vertices (an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">N \times 3</annotation></semantics></math>
array of positions), faces (an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">M \times 3</annotation></semantics></math>
array of triangle indices), and normals (an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">N \times 3</annotation></semantics></math>
array of surface normals). Creating a Mesh visual from this data is
straightforward, but note that the mesh is immediately added to the
scene graph by setting <code>parent=view.scene</code>. This operation
must happen on the main thread, which is why the Flask server runs in a
daemon thread while VisPy owns the main thread.</p>
<h1 id="dynamic-script-execution">Dynamic Script Execution</h1>
<p>The Script component allows clients to attach executable Python code
to entities. This is where the engine becomes truly flexible. Scripts
can define <code>on_load</code> (called once when the script is
attached) and <code>on_update</code> (called every frame at 60 FPS)
functions. The server dynamically imports the script module and executes
these functions in the engine context:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> handle_script_component(entity_id, script: Script):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    script_path <span class="op">=</span> script.script_path</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    script_name <span class="op">=</span> os.path.splitext(os.path.basename(script_path))[<span class="dv">0</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    spec <span class="op">=</span> importlib.util.spec_from_file_location(script_name, script_path)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    script_module <span class="op">=</span> importlib.util.module_from_spec(spec)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    spec.loader.exec_module(script_module)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> world_lock:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        esper.add_component(entity_id, Script(script_path))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    script_info <span class="op">=</span> {}</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(script_module, <span class="st">&quot;on_load&quot;</span>):</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        script_module.on_load(entity_id)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        script_info <span class="op">=</span> {</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;scriptPath&quot;</span>: script_path,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;scriptModule&quot;</span>: script_module</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(script_module, <span class="st">&quot;on_update&quot;</span>):</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> on_update(event):</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            mesh <span class="op">=</span> <span class="bu">next</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                (m <span class="cf">for</span> m <span class="kw">in</span> meshes <span class="cf">if</span> m[<span class="st">&quot;entityId&quot;</span>] <span class="op">==</span> entity_id),</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                <span class="va">None</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mesh <span class="kw">and</span> mesh[<span class="st">&quot;toBeTransformed&quot;</span>]:</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                transform <span class="op">=</span> esper.component_for_entity(entity_id, Transform)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                mesh[<span class="st">&quot;meshObject&quot;</span>].transform.translate(</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">tuple</span>(transform.position)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                mesh[<span class="st">&quot;meshObject&quot;</span>].transform.scale(</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">tuple</span>(transform.scale)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                mesh[<span class="st">&quot;toBeTransformed&quot;</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            script_module.on_update(event)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        timer <span class="op">=</span> vispy.app.Timer(interval<span class="op">=</span><span class="dv">1</span><span class="op">/</span><span class="dv">60</span>, <span class="ex">connect</span><span class="op">=</span>on_update, start<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        script_info[<span class="st">&quot;timer&quot;</span>] <span class="op">=</span> timer</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        script_info[<span class="st">&quot;entityIds&quot;</span>] <span class="op">=</span> [entity_id]</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> scripts_lock:</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        scripts.append(script_info)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_response()</span></code></pre></div>
<p>The <code>on_update</code> wrapper handles transform application
before delegating to the script’s update function. This ensures that
Transform components are synchronized with mesh visuals every frame. The
transform application uses VisPy’s matrix transform API:
<code>translate</code> shifts the mesh by the position vector, and
<code>scale</code> multiplies vertices by the scale vector.</p>
<p>A sample script demonstrates the pattern. This script creates a
rotating cube by attaching Transform and Renderer components in
<code>on_load</code>, then continuously rotating the mesh in
<code>on_update</code>:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> server.api <span class="im">as</span> api</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> server.entity_components <span class="im">import</span> <span class="op">*</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> server.api <span class="im">import</span> meshes</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>local_entity_id <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_load(entity_id):</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    logger.critical(<span class="st">&quot;My custom script has loaded!&quot;</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> local_entity_id</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    local_entity_id <span class="op">=</span> entity_id</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> Transform(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        position<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>],</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        scale<span class="op">=</span>[<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    api.add_component_to_entity(entity_id, transform)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    renderer <span class="op">=</span> Renderer(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        file_path<span class="op">=</span><span class="st">&quot;/path/to/cube.obj&quot;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    api.add_component_to_entity(entity_id, renderer)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_update(event):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    mesh <span class="op">=</span> <span class="bu">next</span>(</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        (m <span class="cf">for</span> m <span class="kw">in</span> meshes <span class="cf">if</span> m[<span class="st">&quot;entityId&quot;</span>] <span class="op">==</span> local_entity_id),</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">None</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mesh:</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        mesh[<span class="st">&quot;meshObject&quot;</span>].transform.rotate(<span class="fl">0.1</span>, [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f&quot;Mesh </span><span class="sc">{</span>local_entity_id<span class="sc">}</span><span class="ss"> not found&quot;</span>)</span></code></pre></div>
<p>The <code>rotate</code> method applies a rotation matrix:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.1</mn><annotation encoding="application/x-tex">0.1</annotation></semantics></math>
radians around the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>0</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 1, 0]</annotation></semantics></math>
axis (Y-axis in VisPy’s coordinate system). Since <code>on_update</code>
is called 60 times per second, this produces smooth rotation at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>
radians per second, or approximately one full rotation per second.</p>
<p>Scripts have full access to the engine’s internals. They can import
<code>server.api</code> to call functions like
<code>add_component_to_entity</code>, access global state like the
<code>meshes</code> registry, and use Esper directly to query
components. This power comes with responsibility: poorly written scripts
can deadlock the engine or corrupt state. In a production engine, I
would sandbox script execution using restricted imports or a separate
interpreter instance.</p>
<h1 id="restful-api-design">RESTful API Design</h1>
<p>The HTTP API exposes six primary endpoints for engine control. The
<code>/create_entity</code> endpoint accepts a JSON payload with entity
metadata and returns the created entity ID:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:5001/create_entity <span class="dt">\</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;name&quot;: &quot;CubeEntity&quot;,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;targetScene&quot;: &quot;MainScene&quot;,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;tags&quot;: [&quot;cube&quot;]</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">  }&#39;</span></span></code></pre></div>
<p>Response:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;success&quot;</span><span class="fu">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;entityId&quot;</span><span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-13T10:30:00Z&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The <code>/add_component_to_entity</code> endpoint attaches a
component to an existing entity. The component type determines the
required data fields:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:5001/add_component_to_entity <span class="dt">\</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;entityId&quot;: 1,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;type&quot;: &quot;transform&quot;,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;data&quot;: {</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;position&quot;: [1.0, 2.0, 0.0],</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;scale&quot;: [0.5, 1.0, 1.5]</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="st">  }&#39;</span></span></code></pre></div>
<p>The <code>/get_entity_components</code> endpoint retrieves all
components for a given entity:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> GET http://localhost:5001/get_entity_components <span class="dt">\</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;entityId&quot;: 1}&#39;</span></span></code></pre></div>
<p>Response:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;success&quot;</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;components&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Transform&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;position&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fl">1.0</span><span class="ot">,</span> <span class="fl">2.0</span><span class="ot">,</span> <span class="fl">0.0</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;scale&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fl">0.5</span><span class="ot">,</span> <span class="fl">1.0</span><span class="ot">,</span> <span class="fl">1.5</span><span class="ot">]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Renderer&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;filePath&quot;</span><span class="fu">:</span> <span class="st">&quot;/path/to/cube.obj&quot;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CoreProperties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;CubeEntity&quot;</span><span class="fu">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;tags&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;cube&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;targetScene&quot;</span><span class="fu">:</span> <span class="st">&quot;MainScene&quot;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-13T10:31:00Z&quot;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The <code>/remove_entity</code> endpoint deletes an entity and cleans
up its associated resources:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> DELETE http://localhost:5001/remove_entity <span class="dt">\</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;entityId&quot;: 1}&#39;</span></span></code></pre></div>
<p>Removal is complex because it must clean up multiple subsystems. The
entity is deleted from Esper, meshes are removed from the scene graph
and the global registry, script timers are stopped and disconnected, and
entity IDs are removed from script tracking lists:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_entity(entity_id):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> meshes, scripts</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> world_lock:</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> esper.entity_exists(entity_id):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Entity </span><span class="sc">{</span>entity_id<span class="sc">}</span><span class="ss"> not found&quot;</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        esper.delete_entity(entity_id)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> meshes_lock:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            meshes_to_remove <span class="op">=</span> [</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                m <span class="cf">for</span> m <span class="kw">in</span> meshes <span class="cf">if</span> m[<span class="st">&quot;entityId&quot;</span>] <span class="op">==</span> entity_id</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> mesh <span class="kw">in</span> meshes_to_remove:</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                mesh[<span class="st">&quot;meshObject&quot;</span>].parent <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                mesh[<span class="st">&quot;meshObject&quot;</span>].transform <span class="op">=</span> MatrixTransform()</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            meshes <span class="op">=</span> [</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                m <span class="cf">for</span> m <span class="kw">in</span> meshes <span class="cf">if</span> m[<span class="st">&quot;entityId&quot;</span>] <span class="op">!=</span> entity_id</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> scripts_lock:</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            scripts_to_remove <span class="op">=</span> [</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                s <span class="cf">for</span> s <span class="kw">in</span> scripts <span class="cf">if</span> entity_id <span class="kw">in</span> s[<span class="st">&quot;entityIds&quot;</span>]</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> script <span class="kw">in</span> scripts_to_remove:</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>                script[<span class="st">&quot;timer&quot;</span>].stop()</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>                script[<span class="st">&quot;timer&quot;</span>].disconnect()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>                script[<span class="st">&quot;entityIds&quot;</span>].remove(entity_id)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>            scripts <span class="op">=</span> [</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>                s <span class="cf">for</span> s <span class="kw">in</span> scripts <span class="cf">if</span> entity_id <span class="kw">not</span> <span class="kw">in</span> s[<span class="st">&quot;entityIds&quot;</span>]</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            ]</span></code></pre></div>
<p>Setting <code>mesh["meshObject"].parent = None</code> detaches the
mesh from the scene graph, making it invisible and eligible for garbage
collection. Resetting the transform to a fresh
<code>MatrixTransform()</code> ensures no residual state affects future
entities.</p>
<p>The <code>/status</code> and <code>/reset</code> endpoints provide
operational control. Status simply confirms the server is responsive,
while reset clears all entities and reinitializes the engine state.</p>
<h1 id="request-validation-and-error-handling">Request Validation and
Error Handling</h1>
<p>Robust input validation prevents client errors from corrupting engine
state. Each component type has a dedicated validation function that
checks data types, required fields, and value constraints:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_transform_data(component_data):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(component_data, <span class="bu">dict</span>):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Transform data must be an object&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    allowed_fields <span class="op">=</span> {<span class="st">&quot;position&quot;</span>, <span class="st">&quot;scale&quot;</span>}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    unexpected_fields <span class="op">=</span> <span class="bu">set</span>(component_data.keys()) <span class="op">-</span> allowed_fields</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unexpected_fields:</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">False</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f&quot;Unexpected fields: </span><span class="sc">{</span><span class="st">&#39;, &#39;</span><span class="sc">.</span>join(unexpected_fields)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    required_fields <span class="op">=</span> [<span class="st">&quot;position&quot;</span>, <span class="st">&quot;scale&quot;</span>]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> field <span class="kw">in</span> required_fields:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> field <span class="kw">not</span> <span class="kw">in</span> component_data:</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span>, <span class="ss">f&quot;Missing required field: </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> component_data[field]</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>):</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span>, <span class="ss">f&quot;</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss"> must be an array&quot;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(value) <span class="op">!=</span> <span class="dv">3</span>:</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span>, <span class="ss">f&quot;</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss"> must contain exactly 3 values&quot;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>(<span class="bu">isinstance</span>(x, (<span class="bu">int</span>, <span class="bu">float</span>)) <span class="cf">for</span> x <span class="kw">in</span> value):</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span>, <span class="ss">f&quot;All </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss"> values must be numbers&quot;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> field <span class="op">==</span> <span class="st">&quot;scale&quot;</span> <span class="kw">and</span> <span class="bu">any</span>(x <span class="op">&lt;=</span> <span class="dv">0</span> <span class="cf">for</span> x <span class="kw">in</span> value):</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Scale values must be positive&quot;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(<span class="bu">abs</span>(x) <span class="op">&gt;</span> <span class="fl">1e6</span> <span class="cf">for</span> x <span class="kw">in</span> value):</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                <span class="va">False</span>,</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss"> values must be within reasonable range&quot;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span>, <span class="va">None</span></span></code></pre></div>
<p>The validation enforces that transforms are well-formed: position and
scale are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>-element
numeric arrays, scale components are strictly positive (negative scale
inverts geometry), and all values are less than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>6</mn></msup><annotation encoding="application/x-tex">10^6</annotation></semantics></math>
in magnitude (prevents numerical instability).</p>
<p>Script validation ensures the provided path points to a valid Python
file:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_script_data(component_data):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    script_path <span class="op">=</span> component_data.get(<span class="st">&quot;scriptPath&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> script_path:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Script path is required&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(script_path, <span class="bu">str</span>):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Script path must be a string&quot;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isfile(script_path):</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Script path must point to a valid file&quot;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> script_path.endswith(<span class="st">&quot;.py&quot;</span>):</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;Script path must have a .py extension&quot;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span>, <span class="va">None</span></span></code></pre></div>
<p>Renderer validation checks that the mesh file exists and has a
supported extension:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_renderer_data(component_data):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> component_data.get(<span class="st">&quot;filePath&quot;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> file_path:</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;File path is required&quot;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(file_path, <span class="bu">str</span>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;File path must be a string&quot;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isfile(file_path):</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>, <span class="st">&quot;File path must point to a valid file&quot;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    supported_extensions <span class="op">=</span> [<span class="st">&quot;.obj&quot;</span>, <span class="st">&quot;.fbx&quot;</span>, <span class="st">&quot;.dae&quot;</span>, <span class="st">&quot;.gltf&quot;</span>, <span class="st">&quot;.glb&quot;</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(file_path.endswith(ext) <span class="cf">for</span> ext <span class="kw">in</span> supported_extensions):</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">False</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f&quot;File must have supported extension: </span><span class="sc">{</span><span class="st">&#39;, &#39;</span><span class="sc">.</span>join(supported_extensions)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span>, <span class="va">None</span></span></code></pre></div>
<p>Error responses follow a consistent JSON format with status code,
reason, and timestamp:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> error_response(reason, status_code<span class="op">=</span><span class="dv">400</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;status&quot;</span>: <span class="st">&quot;error&quot;</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;reason&quot;</span>: reason,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span>: datetime.datetime.now(datetime.timezone.utc).isoformat(),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify(response), status_code</span></code></pre></div>
<p>The timestamp uses UTC with ISO 8601 formatting, making logs
unambiguous across time zones. Success responses mirror this
structure:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> success_response(data<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;status&quot;</span>: <span class="st">&quot;success&quot;</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;data&quot;</span>: data <span class="kw">or</span> {},</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span>: datetime.datetime.now(datetime.timezone.utc).isoformat(),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify(response), <span class="dv">200</span></span></code></pre></div>
<h1 id="testing-and-automation">Testing and Automation</h1>
<p>I implemented comprehensive tests using Python’s unittest framework
to verify API correctness. The tests cover invalid input handling,
entity lifecycle operations, and concurrent access patterns:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> APITestCase(unittest.TestCase):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setUp(<span class="va">self</span>):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.app <span class="op">=</span> flask_app.test_client()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.app.testing <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_server()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test_full_entity_lifecycle(<span class="va">self</span>):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        create_response <span class="op">=</span> <span class="va">self</span>.app.post(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/create_entity&quot;</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>{</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Lifecycle Test&quot;</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;targetScene&quot;</span>: <span class="st">&quot;Test Scene&quot;</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;tags&quot;</span>: [<span class="st">&quot;test&quot;</span>, <span class="st">&quot;lifecycle&quot;</span>],</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(create_response.status_code, <span class="dv">200</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        entity_id <span class="op">=</span> create_response.get_json()[<span class="st">&quot;data&quot;</span>][<span class="st">&quot;entityId&quot;</span>]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        add_component_response <span class="op">=</span> <span class="va">self</span>.app.post(</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/add_component_to_entity&quot;</span>,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>{</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;entityId&quot;</span>: entity_id,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;type&quot;</span>: <span class="st">&quot;transform&quot;</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;position&quot;</span>: [<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>],</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;scale&quot;</span>: [<span class="fl">1.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>],</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(add_component_response.status_code, <span class="dv">200</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        get_response <span class="op">=</span> <span class="va">self</span>.app.get(</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/get_entity_components&quot;</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>{<span class="st">&quot;entityId&quot;</span>: entity_id}</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(get_response.status_code, <span class="dv">200</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        entity_data <span class="op">=</span> get_response.get_json()[<span class="st">&quot;data&quot;</span>]</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>            entity_data[<span class="st">&quot;components&quot;</span>][<span class="st">&quot;Transform&quot;</span>][<span class="st">&quot;position&quot;</span>],</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>            [<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>]</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        remove_response <span class="op">=</span> <span class="va">self</span>.app.delete(</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/remove_entity&quot;</span>,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>{<span class="st">&quot;entityId&quot;</span>: entity_id}</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(remove_response.status_code, <span class="dv">200</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        get_response_after <span class="op">=</span> <span class="va">self</span>.app.get(</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/get_entity_components&quot;</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>            json<span class="op">=</span>{<span class="st">&quot;entityId&quot;</span>: entity_id}</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.assertEqual(get_response_after.status_code, <span class="dv">404</span>)</span></code></pre></div>
<p>This test verifies the complete lifecycle: create an entity, add a
transform component, retrieve and verify component data, remove the
entity, and confirm it no longer exists.</p>
<p>The Makefile includes a demonstration target that scripts a complete
scenario using curl:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dv">rotating_cube:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>python -m server.main &amp;</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    sleep 2</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    curl -X POST http://localhost:5001/create_entity \</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="ch">-</span><span class="fu">H </span><span class="st">&quot;Content-Type: application/json&quot;</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">      -d </span><span class="st">&#39;{&quot;name&quot;: &quot;CubeEntity&quot;, &quot;targetScene&quot;: &quot;MainScene&quot;, &quot;tags&quot;: [&quot;cube&quot;]}&#39;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    curl -X POST http://localhost:5001/add_component_to_entity \</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="ch">-</span><span class="fu">H </span><span class="st">&quot;Content-Type: application/json&quot;</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">      -d </span><span class="st">&#39;{&quot;entityId&quot;: 1, &quot;type&quot;: &quot;script&quot;, &quot;data&quot;: {&quot;scriptPath&quot;: &quot;/path/to/script.py&quot;}}&#39;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    sleep 5</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    curl -X DELETE http://localhost:5001/remove_entity \</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="ch">-</span><span class="fu">H </span><span class="st">&quot;Content-Type: application/json&quot;</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="fu">      -d </span><span class="st">&#39;{&quot;entityId&quot;: 1}&#39;</span></span></code></pre></div>
<p>This creates an entity, attaches a script that sets up a rotating
cube, waits 5 seconds to observe the rotation, then cleans up by
removing the entity. The script remains running in the background
throughout.</p>
<h1 id="architecture-decisions-and-trade-offs">Architecture Decisions
and Trade-offs</h1>
<p>Several design decisions shaped the final architecture. Running Flask
in a daemon thread while VisPy owns the main thread is necessary because
OpenGL requires main-thread execution on macOS and some Linux
configurations. This complicates shutdown: the Flask thread must be
daemonized so it terminates when the main thread exits, otherwise the
process hangs.</p>
<p>Using global locks for world state is simple but coarse-grained. A
more sophisticated approach would use finer-grained locks (per-entity or
per-component-type) to allow concurrent operations on different
entities. However, this introduces complexity and potential deadlocks if
not carefully designed. For this project, the coarse lock is acceptable
because HTTP requests are relatively infrequent compared to render frame
time.</p>
<p>The script execution model is powerful but unsafe. Scripts run in the
same Python interpreter as the engine, with full access to internals. A
malicious or buggy script can crash the entire server. Production
engines typically sandbox scripts using a restricted API surface,
separate process execution, or embedding a sandboxed scripting language
(Lua, JavaScript). I accepted this risk for development flexibility.</p>
<p>Storing meshes and scripts in global lists indexed by entity ID is
simple but inefficient. Querying requires linear search through the
list. A dictionary keyed by entity ID would provide
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math>
lookup. I kept the list approach because the number of entities in my
test scenarios is small (less than 100), making the linear search
negligible. Scaling to thousands of entities would require the
dictionary optimization.</p>
<p>The <code>toBeTransformed</code> flag is a workaround for
coordinating transform updates between HTTP handlers and the render
loop. When a Transform component is added or modified, the flag is set.
On the next frame, the script’s <code>on_update</code> wrapper applies
the transform and clears the flag. This works but requires careful
ordering: the transform must be applied before the script’s update logic
runs. A more robust solution would use a command queue where HTTP
handlers post transform commands, and the render loop consumes them each
frame.</p>
<h1 id="performance-and-scalability">Performance and Scalability</h1>
<p>The system achieves acceptable performance for interactive use.
Entity creation and component addition take less than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>10</mn><annotation encoding="application/x-tex">10</annotation></semantics></math>
milliseconds on a modern CPU. Mesh rendering performance depends on
polygon count: a cube with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>12</mn><annotation encoding="application/x-tex">12</annotation></semantics></math>
triangles renders at 60 FPS trivially, while a model with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">100,000</annotation></semantics></math>
triangles may drop to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>30</mn><annotation encoding="application/x-tex">30</annotation></semantics></math>-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>40</mn><annotation encoding="application/x-tex">40</annotation></semantics></math>
FPS on integrated graphics. VisPy uses OpenGL for rendering, so
performance scales with GPU capability.</p>
<p>The main bottleneck is script execution. Each script with
<code>on_update</code> runs at 60 FPS, and if update logic is expensive
(complex physics, pathfinding), frame rate suffers. I use VisPy’s
<code>Timer</code> class to invoke updates, which provides no CPU time
budgeting or prioritization. A production engine would implement frame
budget management: allocate a fixed time slice per frame for scripts,
and if updates exceed budget, defer them to the next frame or run them
at lower frequency.</p>
<p>Memory usage is modest. Esper stores components as Python objects,
which have overhead (object header, attribute dictionary). A
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">10,000</annotation></semantics></math>
entity scene with Transform and Renderer components uses approximately
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>50</mn><annotation encoding="application/x-tex">50</annotation></semantics></math>
MB of RAM. Mesh data dominates memory: a model with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">100,000</annotation></semantics></math>
vertices (each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>4</mn><mo>=</mo><mn>12</mn></mrow><annotation encoding="application/x-tex">3 \times 4 = 12</annotation></semantics></math>
bytes for position) requires
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1.2</mn><annotation encoding="application/x-tex">1.2</annotation></semantics></math>
MB. Storing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>100</mn><annotation encoding="application/x-tex">100</annotation></semantics></math>
such models would use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>120</mn><annotation encoding="application/x-tex">120</annotation></semantics></math>
MB just for geometry.</p>
<p>Network latency affects interactivity. Each HTTP request incurs
round-trip time, which on localhost is sub-millisecond but over LAN or
WAN can be tens or hundreds of milliseconds. For real-time control,
WebSockets would provide lower latency through persistent connections
and bidirectional messaging. I implemented basic WebSocket support using
Flask-SocketIO for status queries, demonstrating the pattern:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_socketio <span class="im">import</span> SocketIO, emit</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>socketio <span class="op">=</span> SocketIO(flask_app, async_mode<span class="op">=</span><span class="st">&quot;eventlet&quot;</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="at">@socketio.on</span>(<span class="st">&quot;request_status&quot;</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> handle_status_request():</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;status&quot;</span>: <span class="st">&quot;success&quot;</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;data&quot;</span>: {},</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span>: datetime.datetime.now(datetime.timezone.utc).isoformat(),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    emit(<span class="st">&quot;status_response&quot;</span>, response)</span></code></pre></div>
<p>Extending this to all operations would enable real-time remote
control with minimal latency.</p>
<h1 id="lessons-learned">Lessons Learned</h1>
<p>Building this networked game engine reinforced several important
lessons about system architecture. First, the Entity-Component-System
pattern truly shines for managing complex state. The separation between
data (components) and logic (systems/scripts) made adding new component
types straightforward. I added the Renderer component late in
development, and it required no changes to existing entity or transform
code.</p>
<p>Second, thread synchronization is subtle and error-prone. Early
versions had race conditions where HTTP handlers would modify the scene
graph while VisPy was rendering, causing visual glitches or crashes.
Adding the <code>world_lock</code> and <code>meshes_lock</code> solved
this, but required careful analysis to identify all critical sections.
Tools like ThreadSanitizer would help detect races automatically.</p>
<p>Third, API design matters for usability. The decision to use
camelCase in JSON (matching JavaScript conventions) while internally
using snake_case (Python conventions) created translation overhead but
improved client experience. The validation layer catches errors early
with clear messages, making debugging client code much easier.</p>
<p>Finally, visualization is crucial for debugging game engines. Seeing
the 3D scene update in real-time as I issue HTTP commands immediately
reveals when transforms are incorrect or meshes fail to load. Without
the VisPy visualization, I would be debugging blind, relying solely on
logs and API responses.</p>
<hr />
<p>Implementing a networked game engine with Entity-Component-System
architecture demonstrates how powerful separation of concerns can be.
The ECS pattern provides a flexible foundation for composing game
objects, while the RESTful API enables remote control and automation.
Bridging these two worlds requires careful attention to threading, state
management, and API design, but the result is a satisfying system that
can be controlled programmatically and extended with custom scripts. The
project serves as a foundation for more complex game engine features,
from physics simulation to multi-client synchronization. Understanding
how each layer works, from HTTP request handling to OpenGL rendering,
provides deep appreciation for the engineering complexity that modern
game engines manage.</p>
